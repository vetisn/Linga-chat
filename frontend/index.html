<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>本地 AI 助手</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🤖</text></svg>">
    
    <!-- 代码高亮样式 -->
    <link rel="stylesheet" href="lib/github.min.css">
    
    <!-- KaTeX 数学公式样式 -->
    <link rel="stylesheet" href="lib/katex.min.css">
    
    <!-- 引入外部CSS -->
    <link rel="stylesheet" href="style.css?v=143">
    
    <!-- Markdown解析 -->
    <script src="lib/marked.min.js"></script>
    
    <!-- XSS防护 -->
    <script src="lib/purify.min.js"></script>

    <!-- 代码高亮 -->
    <script src="lib/highlight.min.js"></script>
    
    <!-- KaTeX 数学公式渲染 -->
    <script src="lib/katex.min.js"></script>
</head>
<body>

<div class="app-container" id="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="app-title">🤖 AI 助手</div>
            <div class="sidebar-buttons">
                <button id="new-conversation-btn">新对话</button>
            </div>
        </div>
        <div class="current-chat-info" id="current-chat-info">
            <span class="current-chat-title" id="chat-title">请选择对话</span>
        </div>
        <div class="conversation-list" id="conversation-list"></div>
        <div class="sidebar-footer">
            <button class="settings-btn" id="settings-btn">⚙️ 设置</button>
        </div>
    </div>

    <div class="main-panel">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-footer">
            <div class="chat-toolbar">
                <div class="chat-toggles">
                    <label title="知识库"><input type="checkbox" id="toggle-knowledge"><span>📚</span></label>
                    
                    <!-- MCP 工具选择 -->
                    <div class="toggle-with-popup" id="mcp-toggle-wrapper">
                        <label title="MCP 工具"><input type="checkbox" id="toggle-mcp"><span>🔧</span></label>
                        <div class="toggle-popup" id="mcp-popup">
                            <div class="toggle-popup-title">选择 MCP 服务</div>
                            <div class="toggle-popup-options" id="mcp-options"></div>
                        </div>
                    </div>
                    
                    <label title="联网搜索"><input type="checkbox" id="toggle-web"><span>🌐</span></label>
                    <label title="流式输出"><input type="checkbox" id="toggle-stream" checked><span>⚡</span></label>
                    
                    <!-- 生图模式 -->
                    <div class="toggle-with-popup" id="image-gen-toggle-wrapper">
                        <label title="生图模式"><input type="checkbox" id="toggle-image-gen"><span>🎨</span></label>
                        <div class="toggle-popup" id="image-gen-popup">
                            <div class="toggle-popup-title">🎨 生图设置</div>
                            <div class="toggle-popup-options">
                                <div class="image-gen-option">
                                    <label>选择生图模型</label>
                                    <select id="image-gen-model-select">
                                        <option value="">请先配置生图模型</option>
                                    </select>
                                </div>
                                <div class="image-gen-option">
                                    <label>图片尺寸</label>
                                    <select id="image-gen-size-select">
                                        <option value="1024x1024">1024 × 1024 (方形)</option>
                                        <option value="1792x1024">1792 × 1024 (横向)</option>
                                        <option value="1024x1792">1024 × 1792 (纵向)</option>
                                        <option value="512x512">512 × 512 (小图)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="image-gen-tip">
                                💡 开启后输入描述即可生图，需先在 Provider 中配置生图模型
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat-selectors">
                    <div class="model-selector-wrapper">
                        <span class="model-caps-badge" id="model-caps-badge"></span>
                        <div class="custom-select" id="model-select-wrapper">
                            <div class="custom-select-trigger" id="model-select-trigger">
                                <span class="custom-select-value">未配置</span>
                                <span class="custom-select-arrow">▼</span>
                            </div>
                            <div class="custom-select-dropdown" id="model-select-dropdown"></div>
                            <select id="model-select" style="display:none;">
                                <option value="">未配置</option>
                            </select>
                        </div>
                    </div>
                    <select id="provider-select" title="选择Provider">
                        <option value="">未配置</option>
                    </select>
                </div>
            </div>
            <div class="chat-input-container">
                <textarea id="user-input" placeholder="输入消息，Enter 发送"></textarea>
                <button id="send-btn">发送</button>
            </div>
        </div>
    </div>
</div>

<!-- 设置弹窗 -->
<div class="modal settings-modal" id="settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">⚙️ 系统设置</span>
            <button class="modal-close" data-target="settings-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div style="width: 100%;">
                <!-- 界面设置 -->
                <div class="settings-section">
                    <h4>🎨 界面设置</h4>
                    <div class="settings-row">
                        <label>界面比例</label>
                        <select id="layout-scale-select">
                            <option value="xs">极小</option>
                            <option value="sm">较小</option>
                            <option value="normal" selected>标准</option>
                            <option value="lg">较大</option>
                            <option value="xl">极大</option>
                        </select>
                    </div>
                </div>

                <!-- AI设置 -->
                <div class="settings-section">
                    <h4>🤖 AI设置</h4>
                    <div class="settings-row">
                        <label>自动命名模型</label>
                        <select id="auto-title-model-select">
                            <option value="current">使用当前对话模型</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <label>
                            图片识别方案
                            <span class="help-tip" data-tip="当对话模型不支持图片时，用于识别图片中的文字。支持本地 Tesseract OCR（免费离线），安装后在下拉框中选择即可。安装指南见「知识库管理」页面">?</span>
                        </label>
                        <select id="ocr-method-select">
                            <option value="">不启用</option>
                        </select>
                    </div>
                </div>

                <!-- 联网搜索设置 -->
                <div class="settings-section">
                    <h4>🌐 联网搜索设置</h4>
                    <div class="settings-row">
                        <label>配置搜索API密钥</label>
                        <button type="button" id="manage-search-keys-btn">配置联网搜索</button>
                    </div>
                </div>

                <!-- 管理功能 -->
                <div class="settings-section">
                    <h4>🛠️ 系统管理</h4>
                    <div class="settings-row">
                        <label>模型提供商管理</label>
                        <button type="button" id="manage-providers-btn">管理 Provider</button>
                    </div>
                    <div class="settings-row">
                        <label>知识库管理</label>
                        <button type="button" id="manage-knowledge-btn">管理知识库</button>
                    </div>
                    <div class="settings-row">
                        <label>MCP服务器管理</label>
                        <button type="button" id="manage-mcp-btn">管理 MCP</button>
                    </div>
                    <div class="settings-row">
                        <label>导出调试日志</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="export-logs-hours" style="width: 100px;">
                                <option value="1">1小时</option>
                                <option value="6">6小时</option>
                                <option value="24" selected>24小时</option>
                                <option value="72">3天</option>
                                <option value="168">7天</option>
                            </select>
                            <button type="button" id="export-logs-btn">导出日志</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Provider 管理弹窗 -->
<div class="modal" id="provider-modal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <span class="modal-title">🔧 模型提供商管理</span>
            <button class="modal-close" data-target="provider-modal" data-return="settings-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="provider-list-container">
                <h3>已配置的 Provider</h3>
                <div id="provider-list"></div>
            </div>
            <div class="provider-form-container">
                <h3 id="provider-form-title">新建 Provider</h3>
                <form id="provider-form">
                    <input type="hidden" id="provider-id">
                    <div class="form-row">
                        <label>名称 <span class="required">*</span></label>
                        <input type="text" id="provider-name" required placeholder="如: OpenAI / 智谱AI">
                    </div>
                    <div class="form-row">
                        <label>API Base URL <span class="required">*</span></label>
                        <input type="text" id="provider-api-base" required placeholder="https://api.openai.com/v1">
                    </div>
                    <div class="form-row">
                        <label>API Key</label>
                        <input type="password" id="provider-api-key" placeholder="输入 API Key（可选）">
                        <small id="api-key-hint" style="display:none;">留空则保持原密钥不变</small>
                    </div>
                    
                    <!-- 默认模型配置 -->
                    <div class="form-row">
                        <label>默认模型 <span class="required">*</span></label>
                        <div class="model-config-card default-model-card">
                            <div class="model-inputs">
                                <input type="text" id="provider-default-model" required placeholder="输入模型名称，如 gpt-4o">
                                <input type="text" id="provider-default-model-name" placeholder="自定义名称（可选）">
                            </div>
                            <div class="model-capabilities">
                                <label><input type="checkbox" id="default-cap-vision"> 视觉</label>
                                <label><input type="checkbox" id="default-cap-reasoning"> 推理</label>
                                <label><input type="checkbox" id="default-cap-chat" checked> 对话</label>
                                <label><input type="checkbox" id="default-cap-image-gen"> 生图</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 模型列表 -->
                    <div class="form-row">
                        <label>模型列表</label>
                        <div id="provider-models-container" class="models-list-container">
                            <!-- 动态添加的模型卡片 -->
                        </div>
                        <button type="button" id="add-model-btn" class="add-model-btn">+ 添加模型</button>
                        <small>点击添加更多模型，可为每个模型标记功能</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" id="provider-submit-btn">保存</button>
                        <button type="button" id="provider-form-reset">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 知识库管理弹窗 -->
<div class="modal" id="knowledge-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">📚 知识库管理</span>
            <button class="modal-close" data-target="knowledge-modal" data-return="settings-modal">&times;</button>
        </div>
        <div class="modal-body" style="flex-direction: column; gap: 20px;">
            <!-- 上半部分：知识库列表和上传 -->
            <div style="display: flex; gap: 30px;">
                <div class="kb-list-container">
                    <h3>我的知识库</h3>
                    <div id="kb-list"></div>
                    
                    <h3 style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 12px;">新建知识库</h3>
                    <form id="kb-form">
                        <div class="form-row">
                            <label>名称</label>
                            <input type="text" id="kb-name" placeholder="如: 公司文档">
                        </div>
                        <div class="form-row">
                            <label>描述</label>
                            <input type="text" id="kb-description" placeholder="可选描述">
                        </div>
                        <div class="form-actions">
                            <button type="submit">创建</button>
                        </div>
                    </form>
                </div>
                <div class="kb-upload-container">
                    <h3>上传文档</h3>
                    <form id="kb-upload-form">
                        <div class="form-row">
                            <label>目标知识库</label>
                            <select id="kb-select"></select>
                        </div>
                        
                        <!-- 模型配置区域 -->
                        <div class="kb-model-config">
                            <div class="form-row">
                                <label>
                                    向量模型 <span class="required-badge">必选</span>
                                    <span class="model-help-icon" data-model-type="embedding" title="查看支持的模型">?</span>
                                </label>
                                <select id="embedding-model-select">
                                    <option value="">请选择向量模型</option>
                                </select>
                                <small>用于将文本转换为向量，实现语义搜索</small>
                            </div>
                            
                            <div class="form-row">
                                <label>
                                    重排模型 <span class="optional-badge">可选</span>
                                    <span class="model-help-icon" data-model-type="rerank" title="查看支持的模型">?</span>
                                </label>
                                <select id="rerank-model-select">
                                    <option value="">不使用重排模型</option>
                                </select>
                                <small>对检索结果重新排序，提高相关性</small>
                            </div>
                            
                            <div class="form-row">
                                <label>
                                    图片识别方案 <span class="optional-badge">可选</span>
                                    <span class="model-help-icon" data-model-type="vision" title="查看支持的模型">?</span>
                                </label>
                                <select id="kb-vision-model-select">
                                    <option value="">不启用</option>
                                </select>
                                <small>识别扫描件/图片 PDF 中的文字</small>
                            </div>
                        </div>
                        
                        <!-- 模型帮助弹出框 -->
                        <div class="model-help-popup" id="model-help-popup" style="display: none;">
                            <div class="model-help-header">
                                <span class="model-help-title" id="model-help-title">支持的模型</span>
                                <button class="model-help-close">&times;</button>
                            </div>
                            <div class="model-help-content" id="model-help-content"></div>
                        </div>
                        
                        <div class="form-row">
                            <label style="flex-direction: row; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="kb-extract-graph" checked style="width: auto;"> 
                                自动提取知识图谱
                            </label>
                            <small>从文档中提取实体和关系，增强检索效果</small>
                        </div>
                        
                        <div class="form-row">
                            <label>选择文件 - 支持多选</label>
                            <input type="file" id="kb-file" multiple required accept=".pdf,.docx,.doc,.pptx,.xlsx,.xls,.txt,.md,.csv,.json,.xml,.html,.htm">
                            <small>支持: PDF, Word, PPT, Excel, TXT, Markdown, CSV, JSON, XML, HTML</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit">上传并构建知识库</button>
                        </div>
                    </form>
                    <div id="kb-upload-status" class="status-text"></div>
                    
                    <!-- 知识图谱统计 -->
                    <div id="kb-graph-stats" style="margin-top: 15px; padding: 12px; background: #f5f5f5; border-radius: 6px; display: none;">
                        <h4 style="margin: 0 0 8px 0; color: #333; font-size: 13px;">📊 知识图谱统计</h4>
                        <div id="kb-graph-stats-content" style="font-size: 12px; color: #555;"></div>
                    </div>
                </div>
            </div>
            
            <!-- 下半部分：本地方案引导 -->
            <div class="kb-local-solutions">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">🚀 本地方案（无需 API）</h3>
                <div class="local-solution-cards">
                    <!-- 本地 RAG MCP -->
                    <div class="solution-card">
                        <div class="solution-icon">📦</div>
                        <div class="solution-content">
                            <h4>本地 RAG MCP</h4>
                            <p>完全本地运行的知识库检索，无需 API Key</p>
                            <ul>
                                <li>支持 PDF、DOCX、TXT、Markdown</li>
                                <li>本地向量模型，离线可用</li>
                                <li>语义搜索，理解自然语言</li>
                            </ul>
                            <div class="solution-code">
                                <code>npx mcp-local-rag</code>
                                <button type="button" class="copy-cmd-btn" data-cmd="npx mcp-local-rag">复制</button>
                            </div>
                            <a href="https://github.com/shinpr/mcp-local-rag" target="_blank" class="solution-link">查看文档 →</a>
                        </div>
                    </div>
                    
                    <!-- 本地 OCR -->
                    <div class="solution-card">
                        <div class="solution-icon">👁️</div>
                        <div class="solution-content">
                            <h4>本地 OCR（Tesseract）</h4>
                            <p>识别扫描件/图片PDF中的文字，完全离线运行</p>
                            <ul>
                                <li>支持中英文等多语言识别</li>
                                <li>开源免费，无API调用限制</li>
                                <li>安装后在上方下拉框中选择即可使用</li>
                            </ul>
                            <div class="solution-steps">
                                <div class="step-item">
                                    <span class="step-num">1</span>
                                    <span>下载 <a href="https://github.com/UB-Mannheim/tesseract/wiki" target="_blank">Tesseract 安装包</a>（Windows选64位）</span>
                                </div>
                                <div class="step-item">
                                    <span class="step-num">2</span>
                                    <span>安装时勾选 "Additional language data" → "Chinese Simplified"</span>
                                </div>
                                <div class="step-item">
                                    <span class="step-num">3</span>
                                    <span>安装完成后，将安装路径添加到系统环境变量 PATH</span>
                                </div>
                                <div class="step-item">
                                    <span class="step-num">4</span>
                                    <span>重启本应用，在"图片识别方案"下拉框中选择 Tesseract OCR</span>
                                </div>
                            </div>
                            <small style="color: var(--text-muted); display: block; margin-top: 8px;">
                                💡 验证安装：打开命令行输入 <code>tesseract --version</code>，显示版本号即安装成功
                            </small>
                            <a href="https://tesseract-ocr.github.io/tessdoc/Installation.html" target="_blank" class="solution-link">详细安装指南 →</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MCP服务器管理弹窗 -->
<div class="modal" id="mcp-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">MCP服务器管理</span>
            <button class="modal-close" data-target="mcp-modal" data-return="settings-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="mcp-list-container">
                <h3>已配置的MCP服务器</h3>
                <div id="mcp-list"></div>
            </div>
            <div class="mcp-form-container">
                <h3>新建 / 编辑MCP服务器</h3>
                <form id="mcp-form">
                    <input type="hidden" id="mcp-id">
                    <div class="form-row">
                        <label>服务器名称</label>
                        <input type="text" id="mcp-name" required placeholder="如: github-mcp">
                    </div>
                    <div class="form-row">
                        <label>描述</label>
                        <input type="text" id="mcp-description" placeholder="可选描述">
                    </div>
                    <div class="form-row">
                        <label>连接类型</label>
                        <select id="mcp-connection-type" required>
                            <option value="">请选择连接类型</option>
                            <option value="stdio">STDIO (本地命令)</option>
                            <option value="http">HTTP (远程服务)</option>
                        </select>
                    </div>
                    
                    <!-- STDIO配置 -->
                    <div id="mcp-stdio-config" style="display: none;">
                        <div class="form-row">
                            <label>命令</label>
                            <input type="text" id="mcp-command" placeholder="如: npx">
                        </div>
                        <div class="form-row">
                            <label>参数列表</label>
                            <div id="mcp-args-container">
                                <div class="args-input-group">
                                    <input type="text" class="arg-input" placeholder="输入参数，如 -y">
                                    <button type="button" class="add-arg-btn">+</button>
                                </div>
                            </div>
                            <small style="color: #666; font-size: 12px;">点击 + 添加更多参数</small>
                        </div>
                    </div>
                    
                    <!-- HTTP配置 -->
                    <div id="mcp-http-config" style="display: none;">
                        <div class="form-row">
                            <label>服务URL</label>
                            <input type="url" id="mcp-url" placeholder="https://example.com/mcp">
                        </div>
                    </div>
                    
                    <!-- 环境变量配置 -->
                    <div class="form-row">
                        <label>环境变量 (可选)</label>
                        <div id="mcp-env-container">
                            <div class="env-input-group">
                                <input type="text" class="env-key-input" placeholder="变量名">
                                <input type="text" class="env-value-input" placeholder="变量值">
                                <button type="button" class="add-env-btn">+</button>
                            </div>
                        </div>
                        <small style="color: #666; font-size: 12px;">点击 + 添加更多环境变量</small>
                    </div>
                    
                    <div class="form-row">
                        <label style="flex-direction: row; display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="mcp-is-enabled" checked style="width: auto;"> 启用此服务器
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="submit">保存</button>
                        <button type="button" id="mcp-form-reset">重置</button>
                        <button type="button" id="mcp-test-connection">测试连接</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 联网搜索配置弹窗 -->
<div class="modal" id="search-config-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">🌐 联网搜索配置</span>
            <button class="modal-close" data-target="search-config-modal" data-return="settings-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div style="width: 100%;">
                <form id="search-config-form">
                    <div class="settings-section">
                        <h4>🔍 搜索源配置</h4>
                        
                        <div class="form-row">
                            <label>默认搜索源</label>
                            <select id="search-default-source">
                                <option value="duckduckgo" selected>DuckDuckGo（免费）</option>
                                <option value="tavily">Tavily（需API Key）</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label>Tavily API Key（可选）</label>
                            <input type="password" id="search-tavily-api-key" placeholder="输入Tavily API Key">
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                获取地址: <a href="https://tavily.com/" target="_blank">Tavily.com</a>（有免费额度）
                            </small>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <small style="color: #2e7d32;">
                                💡 DuckDuckGo 搜索完全免费，无需配置 API Key，开箱即用！
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit">保存配置</button>
                        <button type="button" id="search-config-reset">重置</button>
                    </div>
                </form>
                
                <div id="search-config-status" class="status-text" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 引入Markdown处理模块 -->
<script src="markdown.js?v=128"></script>

<!-- 引入外部JavaScript -->
<script src="script.js?v=147"></script>

</body>
</html>